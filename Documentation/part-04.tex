%%
%% Qbe SAS SystemDocumentation
%% (C) Copyright 2001-2004 Christian Hofstaedtler
%%
%% $Id: part-04.tex 39 2004-05-12 14:07:08Z ch $
%%

\cChapter{Qbe SAS Client}

Qbe SAS Client soll primär auf Clientsystemen mit Betriebssystem Windows 2000 und/oder Windows XP Professional laufen. 
Wenn möglich soll nur ein kleiner Teil für den Benutzer sichtbar sein (Anmeldung, Statusabfrage und Abmeldung) - die Funktion des Systems sollte nicht weiter in den Vordergrund gerückt werden.

Ebenfalls soll der gesamte Clientteil nur über einen definierten minimalen Befehlssatz mit dem Qbe Auth Server kommunizieren und keine direkten LDAP API Aufrufe durchführen, um maximale Portabilität (möglicherweise auch von LDAP weg) zu erreichen.
Bestimmte Fehler am Client sollen nicht die Fähigkeit der Kommunikation mit dem Qbe Auth Server beeinträchtigen; Netzwerk-Disconnects sollen (besonders auf Laptops) transparent behandelt werden.

\section{Betriebsarten}

Qbe SAS Client übernimmt die Authentifizierung des Benutzers, der einen beliebigen Client PC im Netzwerk benutzen möchte. 
Dazu kann der Client in zwei verschiedenen Modi betrieben werden:

\begin{description}
\item[Network only]
Qbe SAS Client authentifiziert den Benutzer nur gegenüber dem Server. 
Der Benutzer gibt seinen Benutzernamen und Passwort getrennt von der Windows-Anmeldung ein.
\item[System Logon]
Qbe SAS Client authentifiziert den Benutzer sowohl gegenüber Windows als auch dem Qbe Server - bereits beim Anmelden an die Windows Workstation. 
Bei Bedarf wird ein lokaler Benutzer mit konfigurierbaren Rechten angelegt, und bei der Abmeldung wieder gelöscht.
\end{description}

\section{Serversuche}

Der zu benutzende Server wird ausschließlich per DNS gefunden. Standard\-mäßig benutzt Qbe SAS Client den Servernamen "qbe-auth". Die Auflösung des Namens in eine IP Adresse wird vom Betriebssystem durchgeführt - Voraussetzungen dafür sind:
\begin{itemize}
\item \index{DNS}{DNS}-Server läuft und ist richtig konfiguriert \\
	("\index{qbe-auth}{qbe-auth}" ist als A-Record eingetragen.)
\item Die Workstation kann den DNS-Server erreichen, und fragt mit dem richtigen Domainsuffix an. Die richtige Konfiguration der Workstation wird vorzugsweise mittels \index{DHCP}{DHCP} erreicht.
\end{itemize}

In der aktuell vorhandenen Version besteht keine Möglichkeit den anfänglichen Servernamen zu ändern. Geplant ist, eine eigene DHCP-Option, die vom Qbe SAS Client ausgelesen werden kann - Voraussetzung dafür wäre, dass die Workstation die IP-Stack Konfiguration vom DHCP-Server bekommt.

\begin{Verbatim}
; DNS-Beispieleintrag:
qbe-auth.htlwrn.ac.at.	IN	A		10.0.2.100
\end{Verbatim}

 
\section{Einzelteile}

Der Qbe SAS Client ist ein komplexes System, dass aus vielen kleineren Teilen besteht:

\begin{tabular}{|l|l|l|}
\hline
Teilsystem & Dateiname \\
\hline
Network Authentication Service & QbeSvc.exe \\
 & \index{QbeSAS.DLL}{QbeSAS.dll} \\
System Logon & QbeGina.dll \\
Statusanzeige & QbeTray.exe  \\
UI Components & SASClient.hta \\
& startup.hta \\
& Q.ico \\
Einstellungen & SASClient.reg \\
Installation & ServicePack.exe \\
 & netQbe.inf \\
 & QbePFC.exe \\
\hline
\end{tabular}

Qbe SAS Client kann bereits nur mit dem installiertem "qbesvc.exe" und der "QbeSAS.dll" im "Network only" Modus betrieben werden -- der Xplat Client implementiert prinzipiell nichts anderes und kann auch unter Windows gestartet werden. 
Für den "System Logon" Modus bzw. für eine benutzerfreundlichere Umgebung, sollte der Client vollständig installiert werden.


%\begin{center}
%	\includegraphics[width=1.00\textwidth]{files/pic-03-beziehungsdiagramm}
%\end{center}
\placefigx{client}{Beziehungsdiagramm Qbe SAS Client/Server}{width=13cm}


Im Beziehungsdiagramm wird deutlich, dass der Network Authentication Service alle grundlegenden Dienste für den SAS Client zur Verfügung stellt. Wird der System Logon Mode benutzt, wird ein zusätzlicher Teil systemwichtig -- die SASGina. Dieser wird in das Windows Login eingebunden, und übernimmt die Windows Anmeldung und die Authentifizierung gegenüber dem \index{LDAP}{LDAP} Server.

\subsection{Network Authentication Service}

Dieser läuft als Windows-Dienst und implementiert sowohl einen \index{HTTP-SSL}{HTTP-SSL} Client für die Kommunikation mit dem Qbe-Auth Server, 
als auch einen \index{HTTP}{HTTP} Server (auf TCP/IP Port 7666), der die Interaktion mit dem Benutzer ermöglicht und Teile des Authentifizierungshandshakes abarbeitet. 
Auf den Network Authentication Service kann mit einem normalen Webbrowser zugegriffen werden, speziell wurde dies aber für den Internet Explorer (bzw. für die Microsoft HTML Engine) entwickelt und optimiert, da die restlichen Benutzerinterface-Teile auf der Microsoft HTML Engine aufsetzen. 

Alle weiteren Teile kommunizieren ausschließlich mit dem Network Authentication Service, der alle relevanten Daten über den Benutzer im Speicher hält - diese Daten werden regelmäßig vom Server aufgefrischt.

Der HTTP Server ermöglicht es dem Server außerdem, bestimmte Parameter (Benutzername, Servername, Letzte Verbindung, ...) abzufragen, sowie Programme auszuführen (etwa um einen Drucker zu installieren). Dies wird durch eine Abfrage der IP-Adresse geschützt.

\placefigx{scr-win32client}{Screenshot Qbe SAS Client unter Windows}{width=9cm}

\subsection{COM API and Authentication Helper}

Das COM API ermöglicht es, auf den Network Authentication Service per Microsoft COM (ActiveX) zuzugreifen. Gleichzeitig erlaubt es eine Speicherung der Benutzerdaten (Username und Passwort) in der Registry, um die Anmeldung zu beschleunigen.

Bis zur Version 2.23.96-pre wurde eine DLL (geschrieben in Visual Basic 6) verwendet, die ein normales COM Objekt implementiert.
Jetzt wird dies durch die Klasse QbeSAS::DataStore (in der .NET QbeSAS.dll) implementiert. 

\subsection{Statusanzeige}

Die Statusanzeige besteht aus einem Windows System Tray Symbol, dass den aktuellen Internetstatus signalisiert, wichtige Ereignisse dem Benutzer mitteilt (Internet freigegeben) und schnellen Zugriff auf die Client Statusseite und Anmeldung erlaubt.
Für die Statusseite wird die \verb|SASClient.hta| gestartet, beim Start des QbeTray wird die \verb|startup.hta| aufgerufen.

Energie-Events werden vom \index{Trayicon} Tray Symbol behandelt. 
Bei einem kritischen Energieereignis (Standby/Ruhezustand) wird versucht, eine Abmeldung durch den Network Authentication Service zu erreichen. 
30 Sekunden nach dem Aufwachen wird eine transparente Verbindungswiederherstellung eingeleitet.

\subsection{UI Components}

Die sogenannten UI Components bestehen lediglich aus Beschreibungsdateien für \href{http://msdn.microsoft.com/workshop/author/hta/overview/htaoverview.asp}{Microsoft HTA Applikationen}, die auf den http Server im Network Authentication Service verweisen.

Die Datei \verb|startup.hta| wird beim Starten des Clients geladen und verweist auf \verb|/rpc/client/svc-frame?mode=startup| am Authentication Server.

Die Datei \verb|SASClient.hta| wird beim Linksklick auf das Q-\index{Trayicon}{Trayicon} geladen und verweist auf \verb|/rpc/client/svc-frame| am Authentication Server.


\subsection{Automatische Einstellungen}

Qbe SAS Client installiert bei der Anmeldung einige Standardeinstellungen (z.B. Proxykonfiguration), die direkt aus der Datei "iLogin.reg" kommen. Diese wird mit Hilfe vom Windows Registrierungseditor (regedit.exe) automatisch in die Registry importiert.

\subsection{Update}
Da der Client bei jeder Anmeldung die Versionsnummer an den Server sendet, können alte/problematische Client-Versionen einfach ausgeschlossen werden. Clients die den Statuscode \verb|404 - Not found| erhalten, sollten keine weitere Anfrage an den Server schicken.

Neuere Windows Clients (ab 2.01) stellen die Benutzerschnittstelle erst nach einer Anfrage an den Server dar. Damit kann ein Update des Clients erzwungen werden. Workstations mit HDGUARD werden am Client abgefragt und das Zwangsupdate wird übersprungen.


\section{Installation}
Das Setup bietet keine weiteren Optionen an, und entpackt zuerst alle Dateien nach \%SystemRoot\%/System32/Qbe/Setup. 
Die weitere Reihenfolge:

\begin{itemize}
\item[-] Eine eventuell vorhandene, alte Version wird deinstalliert
\item[-] .NET VM wird gegebenenfalls heruntergeladen und installiert
\item[-] \%SystemRoot\%/System32/Qbe/Setup wird komplett gelöscht
\item[-] PFC wird in das System kopiert und ausgeführt (siehe unten)
\item[-] Dateien von früheren Versionen die nach \%SystemRoot\%/System32 und \%ProgramFiles\%/iLogin installiert wurden werden gelöscht
\item[-] Alle Dateien werden nach \%SystemRoot\%/System32/Qbe/Setup kopiert
\item[-] Windows installiert den Qbe SAS Client nach \%SystemRoot\%/System32/Qbe
\item[-] QbePFC /s registriert die \index{QbeSAS.DLL}{QbeSAS.DLL} im \index{Global Assembly Cache}{Global Assembly Cache}
\item[-] QbeGina wird nicht automatisch installiert sondern muss mit dem QbeLogin.exe installiert werden
\end{itemize}

\subsection{PFC}
Qbe "Pre-Flight-Check" ist eine .NET Anwendung (ClientSource/QbePFC), die vor der eigentlichen Installation ausgeführt wird und folgende Tasks erledigt:
\begin{itemize}
\item vorherigen Versionen von QbeSvc, QbeTray, iLogin, etc. schliessen
\item QbeSvc aus der Registry entfernen
\item HTA-Ausführungsschicht (MSHTA) und Internet Explorer beenden
\end{itemize}

Ab Client-Version 2.23.96-pre enthält QbePFC auch ein .NET-to-COM Registrierungsmodul, dieses wird mit dem Parameter "/c" angesprochen.
Dies wurde notwendig da .NET-Objekte die als COM-Objekte verwendet werden, im .NET \index{Global Assembly Cache}{Global Assembly Cache} registriert werden müssen.
Das .NET-Objekt ist hier die Klasse QbeSAS::DataStore und wird von den MSHTA Seiten aufgerufen.

\subsection{System-Updates}

Der SAS Client (für Windows) benötigt Windows 2000 oder XP mit installiertem .NET Framework. Das aktuelle Servicepack auf den Zielsystemen ist nicht zwingend erforderlich, wäre aber von Vorteil.
Das Client Setup prüft vor der eigentlichen Client-Installation ob das .NET Framework und die Microsoft C++ Runtimes in Version 7.1 vorhanden sind - wenn nicht wird beides heruntergeladen und installiert.

\subsection{.NET Framework}
Die .NET Framework Version wird mittels Registry-Key überprüft, andernfalls wird das Setup heruntergeladen und gestartet.
Das SAS Client Setup wird dabei nicht unterbrochen, sondern wartet nur auf das .NET Framework Setup.

\begin{Verbatim}
URL: http://qbe-auth.htlwrn.ac.at/modules/client/files/dotnetfx.exe

ch@xtc:/qbe/web/htdocs/modules/client/files/ -> ls -la dotnetfx.exe
-rw-rw-r--  ch   sysops   24277024 Mar  4  2003 dotnetfx.exe
\end{Verbatim}	

\section{Windows Client kompilieren}
Um die Qbe SAS Client Sourcen zu kompilieren, muss folgende Software auf dem Entwicklungssystem gegeben sein:

\begin{itemize}
\item Microsoft Visual Studio .NET 2003 mit C++ und C\# Unterstützung
\item Microsoft Platform SDK, February 2003
\item GCC 3.x aus dem Cygwin Paket
\item Nullsoft Install System 2.0
\item Mono MCS für den mono/Xplat Build
\end{itemize}

Es muss die Umgebungsvariable \verb|%DEVELDRIVE%| auf das Installationslaufwerk obiger Software gesetzt sein. Zum Beispiel: \verb|set DEVELDRIVE=C:| wenn die Software auf C: installiert wurde.
Weiters darf keines der Visual Studio Setups den PATH oder LIBS/INCLUDE etc. verändert haben. Diese Variablen werden durch das build-Skript automatisch für das Microsoft Platform SDK gesetzt.

Das Build-Skript setzt folgende Installationspfade voraus:
\begin{description}
\item[Visual Studio] "\%DEVELDRIVE\%/Programme/Microsoft Visual Studio 2003"
\item[Cygwin/GCC] kein Pfad, muss bereits im \%PATH\% eingetragen sein
\item[Platform SDK] "\%DEVELDRIVE\%/Programme/Microsoft SDK"
\item[NSIS 2.0] "\%DEVELDRIVE\%/Programme/NSIS20"
\end{description}

\subsection{NSIS Patch}
Der SAS Client Installer erfordert folgenden Patch des "NSISdl" Modules.
Damit wird die Proxy-Konfiguration nicht mehr automatisch aus den Internet Explorer Einstellungen ausgelesen.

\lstinputlisting{files/nsisdl-noproxy.patch}

\subsection{Kompilierungsskript}
Um die Erstellung des Qbe SAS Client Installers drastisch zu vereinfachen, wurden alle Komponenten mit einem Makefile versehen. 
Die Makefiles werden durch das Skript "buildx.bat" in der richtigen Reihenfolge aufgerufen, welches wiederum über eines der build-w2k.bat oder build-wxp.bat aufgerufen wird. 
Die build-xxx.bat Skripte starten zuerst das Platform SDK \verb|setenv.bat| mit Parametern, um das Build-Environment entsprechend herzurichten. Anschliessend wird buildx.bat ausgeführt... 
Die Zieldateien werden im Verzeichnis BIN/RETAIL/PLATFORMNAME erstellt. 

\subsection{Versionsnummern}

Die Versionsnummer wird in der Datei Common/ilogin-version.h definiert. 
Die Datei wird von sehr vielen Komponenten benutzt um die Qbe SAS Client Ziel-Version zu ermitteln und darzustellen.

\section{Qbe SAS Xplat Client}

Der komplexe Aufbau und die enge Verwebung mit dem Windows Betriebssystem machen es (mit heutigen Mitteln) unmöglich, den normalen Qbe SAS Client unter z.B. Linux zu verwenden. 

Auf der anderen Seite macht die .NET Architektur dies sehr einfach. So kann, mit der Annahme dass es pro PC nur einen Benutzer gibt, der gleiche Sourcecode verwendet werden, um ein mit Mono ausführbares Binary zu erstellen.
Dieses Binary ("QbeService.exe") enthält dann die minimalste Funktionalität, die der Qbe SAS Client mitbringen muss. Da das User Interface hier ebenfalls über HTTP ausgeliefert wird, sieht der Client für den Endanwender relativ ähnlich zum Windows Client aus.

\placefig{scr-unixclientui}{Screenshot: Qbe SAS Client unter Linux: Benutzeroberfläche}

Zusätzlich zu dem QbeService.exe sind im Source-Tree ein paar Skripte, die die Verwendung mit Gnome als X11-Umgebung erleichtern können.

\placefig{scr-unixclientshell}{Screenshot: Qbe SAS Client unter Linux: Terminalfenster}

\clearpage

\section{System Logon}
Die QbeGina und unterstützende Dateien werden mit dem "Windows Logon Enabler" Setup installiert.
Die aktuelle Version implementiert eine transparente LDAP-Authentifizierung. Benutzer werden automatisch angelegt bzw. gelöscht. Homedirectory wird entsprechend eingestellt, der Profilpfad wird auf \%HOMEDRIVE\%/profile gesetzt. Im Anmeldedialogfeld kann mit der Tastenkombination CTRL-ALT-DEL die LDAP-Authentifizierung übersprungen werden -- dann wird die normale MSGina.dll für diese Session aktiv.

Die Installation legt die Gruppe "Qbe SAS Users" an und trägt folgende Registry-Änderungen ein:

\begin{lstlisting}
; Registry Aenderungen
[HKEY_LOCAL_MACHINE/Software/Microsoft/Windows NT/CurrentVersion/Winlogon]
GinaDLL="QbeGina.DLL"
ComputerName="ComputerName"

[HKEY_LOCAL_MACHINE/SYSTEM/CurrentControlSet/Services/QbeNP]

[HKEY_LOCAL_MACHINE/SYSTEM/CurrentControlSet/Control/NetworkProvider/Order]
ProviderOrder+="QbeNP"
\end{lstlisting}

\subsection{Arbeitsweise}

Beim Windows \keyword{Boot} wird statt dem Windows Login Fenster ein Fenster mit der Schrift "Qbe SAS - Strg-Alt-Entf zum anmelden." angezeigt.

%\placefigx{qbegina-workflow-p1}{Ablaufdiagramm: QbeGina Initialisierungsvorgang}{width=3.3cm}

Drückt man dann Strg-Alt-Entf, beginnt die QbeGina die Policy-Konfiguration vom Server herunterzuladen. Dann gelangt man zur \keyword{Anmeldung}. 
Die QbeGina fragt hier den Benutzer um seinen Accountnamen und das Passwort, lässt aber keine Auswahl zwischen lokaler Anmeldung oder Netzwerk-Anmeldung zu. 
Um eine lokale Anmeldung zu erzwingen, kann man in diesem Fenster nochmals Strg-Alt-Enf drücken (damit wird ein \index{Winlogon}{Winlogon} SAS Event ausgelöst) und man kommt zum normalen Windows Anmeldedialog.


Kann die QbeGina nach der Benutzerdatenabfrage die Verbindung zum LDAP Server nicht mehr wiederherstellen, wird der Benutzer gefragt, ob er eine lokale Anmeldung versuchen möchte (Bild \ref{fig:scr-qbegina-ldapconnlost}).

Die Arbeitsweise der Anmeldung am Netzwerk und an der Windows Workstation ist aus der Abbildung \ref{fig:qbegina-workflow-p2} ersichtlich.

\placefigx{qbegina-workflow-p2}{Ablaufdiagramm: QbeGina Benutzeranmeldung}{width=13cm}

%Abmelden
Beim \keyword{Abmelden}, wird geprüft ob der Benutzer Mitglied der Gruppe "Qbe SAS Users" ist. Falls dies zutrifft wird der Benutzer und sein lokales Profilverzeichnis gelöscht.

%\placefigx{qbegina-workflow-p3}{Ablaufdiagramm: QbeGina Benutzerabmeldung}{width=3.3cm}

\subsection{Konfiguration durch Policy-Objekt}
Jedes Workstation Objekt kann das Attribut \verb|qbePolicyName| mit einem Verweis auf ein Policy-Objekt enthalten. Dort sind dann folgende Parameter konfigurierbar:

\begin{description}
\item[Dynamic Local User] Legt fest, ob ein lokaler Benutzer angelegt wird falls dieser nicht existiert. Ohne lokalen Benutzer kann keine Anmeldung stattfinden.
\item[Local User Gruppe] Legt fest, in welche Gruppe neue Benutzer hinzugefügt werden. 
Dies kann ein normaler Gruppenname sein, oder einer der folgenden vordefinierten Namen, die dann in die sprachspezifischen Windows Namen konvertiert werden.
 \begin{description}
 \item[BUILTIN/Administrators] Die Administratorengruppe (Administators, Administratoren, \ldots)
 \item[BUILTIN/Power Users] Die Hauptbenutzergruppe (Power Users, Hauptbenutzer, \ldots)
 \item[BUILTIN/Users] Die normale Benutzergruppe (Users, Benutzer, \ldots)
 \item[BUILTIN/Guests] Die Gastgruppe (Guests, Gäste, \ldots)
 \end{description}
\item[Profile Path] Der Profilpfad für den Benutzer. Ein \verb|%s| wird durch den Benutzernamen ersetzt.
\item[Login Script] Pfad zu einem ausführbaren Loginskript. Vorzugsweise wird dafür die QbeLoginScript.exe verwendet. An den kompletten Pfadnamen wird der Benutzername und das Passwort angehängt.
\end{description}
\clearpage

\subsection{Screenshots QbeGina}

\placefigx{scr-qbegina-ctrlaltdel}{Screenshot: QbeGina Fenster vor der Anmeldung}{width=7cm}
\placefigx{scr-qbegina-ldapconnlost}{Screenshot: QbeGina Anmeldung wenn die LDAP Verbindung verloren geht}{width=7cm}
\placefigx{scr-qbegina-loginwithuser}{Screenshot: QbeGina Benutzeranmeldefenster}{width=7cm}

%% *eof*
