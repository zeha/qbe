\hypertarget{QbeSvc_8cpp}{
\section{Qbe\-Svc.cpp Dateireferenz}
\label{QbeSvc_8cpp}\index{QbeSvc.cpp@{QbeSvc.cpp}}
}


{\tt \#include \char`\"{}Std\-Afx.h\char`\"{}}\par
{\tt \#include \char`\"{}service.h\char`\"{}}\par
{\tt \#include $<$sddl.h$>$}\par
{\tt \#include $<$aclapi.h$>$}\par
\subsection*{Funktionen}
\begin{CompactItemize}
\item 
VOID \hyperlink{QbeSvc_8cpp_a2}{Service\-Start} (\hyperlink{QbeGina_8h_a2}{DWORD} dw\-Argc, LPTSTR $\ast$lpsz\-Argv)
\item 
VOID \hyperlink{QbeSvc_8cpp_a3}{Service\-Stop} ()
\end{CompactItemize}
\subsection*{Variablen}
\begin{CompactItemize}
\item 
UINT \hyperlink{QbeSvc_8cpp_a0}{u\-Qbe\-Svc\-Exiting} = 0
\item 
\hyperlink{QbeGina_8h_a0}{HANDLE} \hyperlink{QbeSvc_8cpp_a1}{h\-Server\-Stop\-Event} = NULL
\end{CompactItemize}


\subsection{Dokumentation der Funktionen}
\hypertarget{QbeSvc_8cpp_a2}{
\index{QbeSvc.cpp@{Qbe\-Svc.cpp}!ServiceStart@{ServiceStart}}
\index{ServiceStart@{ServiceStart}!QbeSvc.cpp@{Qbe\-Svc.cpp}}
\subsubsection[ServiceStart]{\setlength{\rightskip}{0pt plus 5cm}VOID Service\-Start (\hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Argc}, LPTSTR $\ast$ {\em lpsz\-Argv})}}
\label{QbeSvc_8cpp_a2}




Definiert in Zeile 41 der Datei Qbe\-Svc.cpp.

Benutzt Add\-To\-Message\-Log(), DWORD, h\-Server\-Stop\-Event, Http\-Service::Kill\-Own\-Thread(), Report\-Status\-To\-SCMgr(), Http\-Service::Run\-As\-Own\-Thread(), u\-Qbe\-Svc\-Exiting und VOID().

Wird benutzt von Cmd\-Debug\-Service() und service\_\-main().



\footnotesize\begin{verbatim}42 {
43   DWORD                   dwWait;
44   bool          bError;
45 
47   //
48   // Service initialization
49   //
50 
51   // report the status to the service control manager.
52   // "Wir starten..."
53   if (!ReportStatusToSCMgr(
54                SERVICE_START_PENDING, // service state
55                NO_ERROR,              // exit code
56                3000))                 // wait hint
57     goto cleanup;
58 
59   // create the event object. The control handler function signals
60   // this event when it receives the "stop" control code.
61   //
62   hServerStopEvent = CreateEvent(
63                  NULL,    // no security attributes
64                  TRUE,    // manual reset event
65                  FALSE,   // not-signalled
66                  NULL);   // no name
67 
68   if ( hServerStopEvent == NULL)
69     goto cleanup;
70 
71   // report the status to the service control manager.
72   // "Wir starten immer noch"
73   if (!ReportStatusToSCMgr(
74                SERVICE_START_PENDING, // service state
75                NO_ERROR,              // exit code
76                3000))                 // wait hint
77     goto cleanup;
78 
79   // Wir starten hier unseren iLogin Service Worker Thread...
80   //
81   bError = false;
82   QbeSAS::HttpService* httpService = new QbeSAS::HttpService(7666,true);
83   bError = httpService->RunAsOwnThread();
84   if (!bError)
85   {
86     AddToMessageLog(MSG_ERROR,TEXT("Worker Thread startup failed. Probably caused because a .NET exception or the port is already in use."));
87     goto cleanup;
88   }
89 
90   // report the status to the service control manager.
91   // "also eigentlich sind wir fertig"
92   if (!ReportStatusToSCMgr(
93                SERVICE_RUNNING,       // service state
94                NO_ERROR,              // exit code
95                0))                    // wait hint
96     goto cleanup;
97 
98   //
99   // End of initialization
100   //
102 
104   //
105   // Der Service läuft jetzt; ein normaler Dienst würde hier
106   // seine Arbeit tun, da dieser Thread hier aber nur ein Control
107     // Thread ist, warten wir einfach auf ein ServiceStop Signal.
108   //
109   while ( 1 )
110   {
111      dwWait = WaitForSingleObject( hServerStopEvent, INFINITE );
112      if (dwWait != WAIT_TIMEOUT)
113      {
114         break;                           // or server stop signaled
115      }
116   }
117 
118   // cleanup; der Service wurde gestoppt.
119   // Wir schliessen das Server Handle.
120 cleanup:
121   uQbeSvcExiting = 1;
122 
123   if (httpService != NULL)
124   {
125     httpService->KillOwnThread();
126     httpService = NULL;
127   }
128 
129   if (hServerStopEvent)
130     CloseHandle(hServerStopEvent);
131 
132   ExitProcess(0);
133 }
\end{verbatim}\normalsize 
\hypertarget{QbeSvc_8cpp_a3}{
\index{QbeSvc.cpp@{Qbe\-Svc.cpp}!ServiceStop@{ServiceStop}}
\index{ServiceStop@{ServiceStop}!QbeSvc.cpp@{Qbe\-Svc.cpp}}
\subsubsection[ServiceStop]{\setlength{\rightskip}{0pt plus 5cm}VOID Service\-Stop ()}}
\label{QbeSvc_8cpp_a3}




Definiert in Zeile 155 der Datei Qbe\-Svc.cpp.

Benutzt h\-Server\-Stop\-Event, u\-Qbe\-Svc\-Exiting und VOID().

Wird benutzt von Control\-Handler() und service\_\-ctrl().



\footnotesize\begin{verbatim}156 {
157   uQbeSvcExiting = 1;
158 
159   if ( hServerStopEvent )
160       SetEvent(hServerStopEvent);
161 }
\end{verbatim}\normalsize 


\subsection{Variablen-Dokumentation}
\hypertarget{QbeSvc_8cpp_a1}{
\index{QbeSvc.cpp@{Qbe\-Svc.cpp}!hServerStopEvent@{hServerStopEvent}}
\index{hServerStopEvent@{hServerStopEvent}!QbeSvc.cpp@{Qbe\-Svc.cpp}}
\subsubsection[hServerStopEvent]{\setlength{\rightskip}{0pt plus 5cm}\hyperlink{QbeGina_8h_a0}{HANDLE} \hyperlink{QbeSvc_8cpp_a1}{h\-Server\-Stop\-Event} = NULL}}
\label{QbeSvc_8cpp_a1}




Definiert in Zeile 19 der Datei Qbe\-Svc.cpp.

Wird benutzt von Service\-Start() und Service\-Stop().\hypertarget{QbeSvc_8cpp_a0}{
\index{QbeSvc.cpp@{Qbe\-Svc.cpp}!uQbeSvcExiting@{uQbeSvcExiting}}
\index{uQbeSvcExiting@{uQbeSvcExiting}!QbeSvc.cpp@{Qbe\-Svc.cpp}}
\subsubsection[uQbeSvcExiting]{\setlength{\rightskip}{0pt plus 5cm}UINT \hyperlink{QbeSvc_8cpp_a0}{u\-Qbe\-Svc\-Exiting} = 0}}
\label{QbeSvc_8cpp_a0}




Definiert in Zeile 14 der Datei Qbe\-Svc.cpp.

Wird benutzt von Service\-Start() und Service\-Stop().