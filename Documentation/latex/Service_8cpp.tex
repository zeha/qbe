\hypertarget{Service_8cpp}{
\section{Service.cpp Dateireferenz}
\label{Service_8cpp}\index{Service.cpp@{Service.cpp}}
}


{\tt \#include \char`\"{}Std\-Afx.h\char`\"{}}\par
{\tt \#include \char`\"{}service.h\char`\"{}}\par
\subsection*{Funktionen}
\begin{CompactItemize}
\item 
VOID WINAPI \hyperlink{Service_8cpp_a5}{service\_\-ctrl} (\hyperlink{QbeGina_8h_a2}{DWORD} dw\-Ctrl\-Code)
\item 
VOID WINAPI \hyperlink{Service_8cpp_a6}{service\_\-main} (\hyperlink{QbeGina_8h_a2}{DWORD} dw\-Argc, LPTSTR $\ast$lpsz\-Argv)
\item 
VOID \hyperlink{Service_8cpp_a7}{Cmd\-Install\-Service} ()
\item 
VOID \hyperlink{Service_8cpp_a8}{Cmd\-Remove\-Service} ()
\item 
VOID \hyperlink{Service_8cpp_a9}{Cmd\-Debug\-Service} (int argc, TCHAR $\ast$argv\mbox{[}$\,$\mbox{]})
\item 
BOOL WINAPI \hyperlink{Service_8cpp_a10}{Control\-Handler} (\hyperlink{QbeGina_8h_a2}{DWORD} dw\-Ctrl\-Type)
\item 
LPTSTR \hyperlink{Service_8cpp_a11}{Get\-Last\-Error\-Text} (LPTSTR lpsz\-Buf, \hyperlink{QbeGina_8h_a2}{DWORD} dw\-Size)
\item 
int \_\-\_\-cdecl \hyperlink{Service_8cpp_a12}{wmain} (int argc, WCHAR $\ast$argv\mbox{[}$\,$\mbox{]}, WCHAR $\ast$envp\mbox{[}$\,$\mbox{]})
\item 
\hyperlink{QbeGina_8h_a2}{DWORD} WINAPI \hyperlink{Service_8cpp_a13}{service\_\-ctrl\-Ex} (\hyperlink{QbeGina_8h_a2}{DWORD} dw\-Control, \hyperlink{QbeGina_8h_a2}{DWORD} dw\-Event\-Type, LPVOID lp\-Event\-Data, LPVOID lp\-Context)
\item 
BOOL \hyperlink{Service_8cpp_a14}{Report\-Status\-To\-SCMgr} (\hyperlink{QbeGina_8h_a2}{DWORD} dw\-Current\-State, \hyperlink{QbeGina_8h_a2}{DWORD} dw\-Win32Exit\-Code, \hyperlink{QbeGina_8h_a2}{DWORD} dw\-Wait\-Hint)
\item 
VOID \hyperlink{Service_8cpp_a15}{Add\-To\-Message\-Log} (\hyperlink{QbeGina_8h_a2}{DWORD} dw\-Message, LPTSTR lpsz\-Msg)
\end{CompactItemize}
\subsection*{Variablen}
\begin{CompactItemize}
\item 
SERVICE\_\-STATUS \hyperlink{Service_8cpp_a0}{ss\-Status}
\item 
SERVICE\_\-STATUS\_\-HANDLE \hyperlink{Service_8cpp_a1}{ssh\-Status\-Handle}
\item 
\hyperlink{QbeGina_8h_a2}{DWORD} \hyperlink{Service_8cpp_a2}{dw\-Err} = 0
\item 
BOOL \hyperlink{Service_8cpp_a3}{b\-Debug} = FALSE
\item 
TCHAR \hyperlink{Service_8cpp_a4}{sz\-Err} \mbox{[}256\mbox{]}
\end{CompactItemize}


\subsection{Dokumentation der Funktionen}
\hypertarget{Service_8cpp_a15}{
\index{Service.cpp@{Service.cpp}!AddToMessageLog@{AddToMessageLog}}
\index{AddToMessageLog@{AddToMessageLog}!Service.cpp@{Service.cpp}}
\subsubsection[AddToMessageLog]{\setlength{\rightskip}{0pt plus 5cm}VOID Add\-To\-Message\-Log (\hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Message}, LPTSTR {\em lpsz\-Msg})}}
\label{Service_8cpp_a15}


FUNCTION: Add\-To\-Message\-Log(LPTSTR lpsz\-Msg)

PURPOSE: Allows any thread to log an error message

PARAMETERS: dw\-Message - message event ID lpsz\-Msg - text for message

RETURN VALUE: none

COMMENTS: 

Definiert in Zeile 334 der Datei Service.cpp.

Benutzt b\-Debug, dw\-Err, HANDLE und VOID().

Wird benutzt von Report\-Status\-To\-SCMgr(), Service\-Start() und wmain().



\footnotesize\begin{verbatim}335 {
336    HANDLE  hEventSource;
337    LPTSTR  lpszStrings[1];
338 
339    if ( !bDebug )
340    {
341       dwErr = GetLastError();
342 
343       // Use event logging to log the error.
344       //
345       hEventSource = RegisterEventSource(NULL, TEXT(SZSERVICENAME));
346 
347       //_stprintf(szMsg, TEXT("%s error: %d"), TEXT(SZSERVICENAME), dwErr);
348       //lpszStrings[0] = szMsg;
349       lpszStrings[0] = lpszMsg;
350 
351       if (hEventSource != NULL)
352       {
353          ReportEvent(hEventSource, // handle of event source
354                      EVENTLOG_ERROR_TYPE,  // event type
355                      0,                    // event category
356                      dwMessage,            // event ID
357                      NULL,                 // current user's SID
358                      2,                    // strings in lpszStrings
359                      0,                    // no bytes of raw data
360                      (const unsigned short**)lpszStrings,          // array of error strings
361                      NULL);                // no raw data
362 
363          (VOID) DeregisterEventSource(hEventSource);
364       }
365    }
366 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a9}{
\index{Service.cpp@{Service.cpp}!CmdDebugService@{CmdDebugService}}
\index{CmdDebugService@{CmdDebugService}!Service.cpp@{Service.cpp}}
\subsubsection[CmdDebugService]{\setlength{\rightskip}{0pt plus 5cm}void Cmd\-Debug\-Service (int {\em argc}, TCHAR $\ast$ {\em argv}\mbox{[}$\,$\mbox{]})}}
\label{Service_8cpp_a9}




Definiert in Zeile 552 der Datei Service.cpp.

Benutzt Control\-Handler(), DWORD und Service\-Start().

Wird benutzt von wmain().



\footnotesize\begin{verbatim}553 {
554    int dwArgc;
555    LPTSTR *lpszArgv;
556 
557 #ifdef UNICODE
558    lpszArgv = CommandLineToArgvW(GetCommandLineW(), &(dwArgc) );
559    if (NULL == lpszArgv)
560    {
561        // CommandLineToArvW failed!!
562        wprintf(TEXT("CmdDebugService CommandLineToArgvW returned NULL\n"));
563        return;
564    }
565 #else
566    dwArgc   = (DWORD) argc;
567    lpszArgv = argv;
568 #endif
569 
570    wprintf(TEXT("Debugging %s.\n"), TEXT(SZSERVICEDISPLAYNAME));
571 
572    SetConsoleCtrlHandler( ControlHandler, TRUE );
573 
574    ServiceStart( dwArgc, lpszArgv );
575 
576 #ifdef UNICODE
577 // Must free memory allocated for arguments
578 
579    GlobalFree(lpszArgv);
580 #endif // UNICODE
581 
582 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a7}{
\index{Service.cpp@{Service.cpp}!CmdInstallService@{CmdInstallService}}
\index{CmdInstallService@{CmdInstallService}!Service.cpp@{Service.cpp}}
\subsubsection[CmdInstallService]{\setlength{\rightskip}{0pt plus 5cm}void Cmd\-Install\-Service ()}}
\label{Service_8cpp_a7}




Definiert in Zeile 390 der Datei Service.cpp.

Benutzt Get\-Last\-Error\-Text() und sz\-Err.

Wird benutzt von wmain().



\footnotesize\begin{verbatim}391 {
392    SC_HANDLE   schService;
393    SC_HANDLE   schSCManager;
394 
395    TCHAR szPath[512];
396    TCHAR szInstallPath[512+15];
397 
398    if ( GetModuleFileName( NULL, szPath, 512 ) == 0 )
399    {
400       wprintf(TEXT("Unable to install %s - %s\n"), TEXT(SZSERVICEDISPLAYNAME), GetLastErrorText(szErr, 256));
401       return;
402    }
403    wcsncpy(szInstallPath,szPath,511);
404    //szInstallPath[511]=0;
405    wcscat(szInstallPath,TEXT(" -start"));
406 
407    schSCManager = OpenSCManager(
408                                NULL,                   // machine (NULL == local)
409                                NULL,                   // database (NULL == default)
410                                SC_MANAGER_CONNECT | SC_MANAGER_CREATE_SERVICE  // access required
411                                );
412    if ( schSCManager )
413    {
414       schService = CreateService(
415                                 schSCManager,               // SCManager database
416                                 TEXT(SZSERVICENAME),        // name of service
417                                 TEXT(SZSERVICEDISPLAYNAME), // name to display
418                                 SERVICE_QUERY_STATUS | SERVICE_CHANGE_CONFIG | SERVICE_START,         // desired access
419                                 SERVICE_INTERACTIVE_PROCESS | SERVICE_WIN32_OWN_PROCESS,  // service type
420                                 SERVICE_AUTO_START,         // start type
421                                 SERVICE_ERROR_NORMAL,       // error control type
422                                 szInstallPath,              // service's binary
423                                 NULL,                       // no load ordering group
424                                 NULL,                       // no tag identifier
425                                 TEXT(SZDEPENDENCIES),       // dependencies
426                                 NULL,                       // LocalSystem account
427                                 NULL);                      // no password
428 
429       if ( schService )
430       {
431     SERVICE_DESCRIPTION sd;
432     sd.lpDescription = TEXT("Used for Qbe-enabled Networks to authenticate and identify the current user.");
433 
434 #if (_WIN32_WINNT > 0x0400)
435     ChangeServiceConfig2 ( schService , SERVICE_CONFIG_DESCRIPTION , &sd );
436 #endif
437 
438          wprintf(TEXT("%s installed.\n"), TEXT(SZSERVICEDISPLAYNAME) );
439 
440      if (StartService(schService, 0, NULL))
441       wprintf(TEXT("%s started.\n"), TEXT(SZSERVICEDISPLAYNAME) );
442 
443          CloseServiceHandle(schService);
444       }
445       else
446       {
447          wprintf(TEXT("CreateService failed - %s\n"), GetLastErrorText(szErr, 256));
448       }
449 
450       CloseServiceHandle(schSCManager);
451    }
452    else
453       wprintf(TEXT("OpenSCManager failed - %s\n"), GetLastErrorText(szErr,256));
454 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a8}{
\index{Service.cpp@{Service.cpp}!CmdRemoveService@{CmdRemoveService}}
\index{CmdRemoveService@{CmdRemoveService}!Service.cpp@{Service.cpp}}
\subsubsection[CmdRemoveService]{\setlength{\rightskip}{0pt plus 5cm}void Cmd\-Remove\-Service ()}}
\label{Service_8cpp_a8}




Definiert in Zeile 471 der Datei Service.cpp.

Benutzt Get\-Last\-Error\-Text(), ss\-Status und sz\-Err.

Wird benutzt von wmain().



\footnotesize\begin{verbatim}472 {
473    SC_HANDLE   schService;
474    SC_HANDLE   schSCManager;
475 
476    schSCManager = OpenSCManager(
477                                NULL,                   // machine (NULL == local)
478                                NULL,                   // database (NULL == default)
479                                SC_MANAGER_CONNECT   // access required
480                                );
481    if ( schSCManager )
482    {
483       schService = OpenService(schSCManager, TEXT(SZSERVICENAME), DELETE | SERVICE_STOP | SERVICE_QUERY_STATUS);
484 
485       if (schService)
486       {
487          // try to stop the service
488          if ( ControlService( schService, SERVICE_CONTROL_STOP, &ssStatus ) )
489          {
490             wprintf(TEXT("Stopping %s."), TEXT(SZSERVICEDISPLAYNAME));
491             Sleep( 1000 );
492 
493             while ( QueryServiceStatus( schService, &ssStatus ) )
494             {
495                if ( ssStatus.dwCurrentState == SERVICE_STOP_PENDING )
496                {
497                   wprintf(TEXT("."));
498                   Sleep( 1000 );
499                }
500                else
501                   break;
502             }
503 
504             if ( ssStatus.dwCurrentState == SERVICE_STOPPED )
505                wprintf(TEXT("\n%s stopped.\n"), TEXT(SZSERVICEDISPLAYNAME) );
506             else
507                wprintf(TEXT("\n%s failed to stop.\n"), TEXT(SZSERVICEDISPLAYNAME) );
508 
509          }
510 
511          // now remove the service
512          if ( DeleteService(schService) )
513             wprintf(TEXT("%s removed.\n"), TEXT(SZSERVICEDISPLAYNAME) );
514          else
515             wprintf(TEXT("DeleteService failed - %s\n"), GetLastErrorText(szErr,256));
516 
517 
518          CloseServiceHandle(schService);
519       }
520       else
521          wprintf(TEXT("OpenService failed - %s\n"), GetLastErrorText(szErr,256));
522 
523       CloseServiceHandle(schSCManager);
524    }
525    else
526       wprintf(TEXT("OpenSCManager failed - %s\n"), GetLastErrorText(szErr,256));
527 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a10}{
\index{Service.cpp@{Service.cpp}!ControlHandler@{ControlHandler}}
\index{ControlHandler@{ControlHandler}!Service.cpp@{Service.cpp}}
\subsubsection[ControlHandler]{\setlength{\rightskip}{0pt plus 5cm}BOOL WINAPI Control\-Handler (\hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Ctrl\-Type})}}
\label{Service_8cpp_a10}




Definiert in Zeile 599 der Datei Service.cpp.

Benutzt BOOL() und Service\-Stop().

Wird benutzt von Cmd\-Debug\-Service().



\footnotesize\begin{verbatim}600 {
601    switch ( dwCtrlType )
602    {
603    case CTRL_BREAK_EVENT:  // use Ctrl+C or Ctrl+Break to simulate
604    case CTRL_C_EVENT:      // SERVICE_CONTROL_STOP in debug mode
605       wprintf(TEXT("Stopping %s.\n"), TEXT(SZSERVICEDISPLAYNAME));
606       ServiceStop();
607       return TRUE;
608       break;
609 
610    }
611    return FALSE;
612 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a11}{
\index{Service.cpp@{Service.cpp}!GetLastErrorText@{GetLastErrorText}}
\index{GetLastErrorText@{GetLastErrorText}!Service.cpp@{Service.cpp}}
\subsubsection[GetLastErrorText]{\setlength{\rightskip}{0pt plus 5cm}LPTSTR Get\-Last\-Error\-Text (LPTSTR {\em lpsz\-Buf}, \hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Size})}}
\label{Service_8cpp_a11}




Definiert in Zeile 628 der Datei Service.cpp.

Benutzt DWORD.

Wird benutzt von Cmd\-Install\-Service() und Cmd\-Remove\-Service().



\footnotesize\begin{verbatim}629 {
630    DWORD dwRet;
631    LPTSTR lpszTemp = NULL;
632 
633    dwRet = FormatMessage( FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM |FORMAT_MESSAGE_ARGUMENT_ARRAY,
634                           NULL,
635                           GetLastError(),
636                           LANG_NEUTRAL,
637                           (LPTSTR)&lpszTemp,
638                           0,
639                           NULL );
640 
641    // supplied buffer is not long enough
642    if ( !dwRet || ( (long)dwSize < (long)dwRet+14 ) )
643       lpszBuf[0] = TEXT('\0');
644    else
645    {
646       lpszTemp[lstrlen(lpszTemp)-2] = TEXT('\0');  //remove cr and newline character
647       wsprintf( lpszBuf, TEXT("%s (0x%x)"), lpszTemp, GetLastError() );
648    }
649 
650    if ( lpszTemp )
651       LocalFree((HLOCAL) lpszTemp );
652 
653    return lpszBuf;
654 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a14}{
\index{Service.cpp@{Service.cpp}!ReportStatusToSCMgr@{ReportStatusToSCMgr}}
\index{ReportStatusToSCMgr@{ReportStatusToSCMgr}!Service.cpp@{Service.cpp}}
\subsubsection[ReportStatusToSCMgr]{\setlength{\rightskip}{0pt plus 5cm}BOOL Report\-Status\-To\-SCMgr (\hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Current\-State}, \hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Win32Exit\-Code}, \hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Wait\-Hint})}}
\label{Service_8cpp_a14}


FUNCTION: \hyperlink{Service_8cpp_a14}{Report\-Status\-To\-SCMgr()}

PURPOSE: Sets the current status of the service and reports it to the Service Control Manager

PARAMETERS: dw\-Current\-State - the state of the service dw\-Win32Exit\-Code - error code to report dw\-Wait\-Hint - worst case estimate to next checkpoint

RETURN VALUE: TRUE - success FALSE - failure

COMMENTS: 

Definiert in Zeile 282 der Datei Service.cpp.

Benutzt Add\-To\-Message\-Log(), b\-Debug, BOOL(), DWORD, ssh\-Status\-Handle und ss\-Status.

Wird benutzt von service\_\-ctrl(), service\_\-main() und Service\-Start().



\footnotesize\begin{verbatim}285 {
286    static DWORD dwCheckPoint = 1;
287    BOOL fResult = TRUE;
288 
289 
290    if ( !bDebug ) // when debugging we don't report to the SCM
291    {
292       if (dwCurrentState == SERVICE_START_PENDING)
293          ssStatus.dwControlsAccepted = 0;
294       else
295          ssStatus.dwControlsAccepted = SERVICE_ACCEPT_STOP;
296 
297       ssStatus.dwCurrentState = dwCurrentState;
298       ssStatus.dwWin32ExitCode = dwWin32ExitCode;
299       ssStatus.dwWaitHint = dwWaitHint;
300 
301       if ( ( dwCurrentState == SERVICE_RUNNING ) ||
302            ( dwCurrentState == SERVICE_STOPPED ) )
303          ssStatus.dwCheckPoint = 0;
304       else
305          ssStatus.dwCheckPoint = dwCheckPoint++;
306 
307 
308       // Report the status of the service to the service control manager.
309       //
310       if (!(fResult = SetServiceStatus( sshStatusHandle, &ssStatus)))
311       {
312          AddToMessageLog(MSG_ERROR,TEXT("SetServiceStatus failed"));
313       }
314    }
315    return fResult;
316 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a5}{
\index{Service.cpp@{Service.cpp}!service_ctrl@{service\_\-ctrl}}
\index{service_ctrl@{service\_\-ctrl}!Service.cpp@{Service.cpp}}
\subsubsection[service\_\-ctrl]{\setlength{\rightskip}{0pt plus 5cm}VOID WINAPI service\_\-ctrl (\hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Ctrl\-Code})}}
\label{Service_8cpp_a5}


FUNCTION: service\_\-ctrl

PURPOSE: This function is called by the SCM whenever Control\-Service() is called on this service.

PARAMETERS: dw\-Ctrl\-Code - type of control requested

RETURN VALUE: none

COMMENTS: 

Definiert in Zeile 230 der Datei Service.cpp.

Benutzt Report\-Status\-To\-SCMgr(), Service\-Stop(), ss\-Status und VOID().

Wird benutzt von service\_\-ctrl\-Ex() und service\_\-main().



\footnotesize\begin{verbatim}231 {
232    // Handle the requested control code.
233    //
234    switch (dwCtrlCode)
235    {
236    // Stop the service.
237    //
238    // SERVICE_STOP_PENDING should be reported before
239    // setting the Stop Event - hServerStopEvent - in
240    // ServiceStop().  This avoids a race condition
241    // which may result in a 1053 - The Service did not respond...
242    // error.
243    case SERVICE_CONTROL_STOP:
244       ReportStatusToSCMgr(SERVICE_STOP_PENDING, NO_ERROR, 0);
245       ServiceStop();
246       return;
247 
248       // Update the service status.
249       //
250    case SERVICE_CONTROL_INTERROGATE:
251       break;
252 
253       // invalid control code
254       //
255    default:
256       break;
257 
258    }
259 
260    ReportStatusToSCMgr(ssStatus.dwCurrentState, NO_ERROR, 0);
261 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a13}{
\index{Service.cpp@{Service.cpp}!service_ctrlEx@{service\_\-ctrlEx}}
\index{service_ctrlEx@{service\_\-ctrlEx}!Service.cpp@{Service.cpp}}
\subsubsection[service\_\-ctrlEx]{\setlength{\rightskip}{0pt plus 5cm}\hyperlink{QbeGina_8h_a2}{DWORD} WINAPI service\_\-ctrl\-Ex (\hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Control}, \hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Event\-Type}, LPVOID {\em lp\-Event\-Data}, LPVOID {\em lp\-Context})}}
\label{Service_8cpp_a13}




Definiert in Zeile 113 der Datei Service.cpp.

Benutzt DWORD und service\_\-ctrl().

Wird benutzt von service\_\-main().



\footnotesize\begin{verbatim}119 {
120 
121   switch (dwControl)
122   {
123     case SERVICE_CONTROL_STOP:
124       service_ctrl(SERVICE_CONTROL_STOP);
125       return NO_ERROR;
126 
127     case SERVICE_CONTROL_INTERROGATE:
128       service_ctrl(SERVICE_CONTROL_INTERROGATE);
129       return NO_ERROR;
130 
131     case SERVICE_CONTROL_POWEREVENT:
132 
133       switch (dwEventType)
134       {
135         case PBT_APMRESUMEAUTOMATIC:
136         case PBT_APMRESUMECRITICAL:
137         case PBT_APMRESUMESUSPEND:
138           break;
139 
140         default:
141           break;
142       }
143       return NO_ERROR;
144 
145     default:
146       return ERROR_CALL_NOT_IMPLEMENTED;
147   }
148 
149 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a6}{
\index{Service.cpp@{Service.cpp}!service_main@{service\_\-main}}
\index{service_main@{service\_\-main}!Service.cpp@{Service.cpp}}
\subsubsection[service\_\-main]{\setlength{\rightskip}{0pt plus 5cm}void WINAPI service\_\-main (\hyperlink{QbeGina_8h_a2}{DWORD} {\em dw\-Argc}, LPTSTR $\ast$ {\em lpsz\-Argv})}}
\label{Service_8cpp_a6}


FUNCTION: service\_\-main

PURPOSE: To perform actual initialization of the service

PARAMETERS: dw\-Argc - number of command line arguments lpsz\-Argv - array of command line arguments

RETURN VALUE: none

COMMENTS: This routine performs the service initialization and then calls the user defined \hyperlink{QbeSvc_8cpp_a2}{Service\-Start()} routine to perform majority of the work. 

Definiert in Zeile 169 der Datei Service.cpp.

Benutzt dw\-Err, Report\-Status\-To\-SCMgr(), service\_\-ctrl(), service\_\-ctrl\-Ex(), Service\-Start(), ssh\-Status\-Handle, ss\-Status und VOID().

Wird benutzt von wmain().



\footnotesize\begin{verbatim}170 {
171     sshStatusHandle = RegisterServiceCtrlHandlerEx ( TEXT(SZSERVICENAME) , service_ctrlEx , NULL ); 
172 
173   if (!sshStatusHandle)
174   {
175     // register our service control handler:
176     //
177     sshStatusHandle = RegisterServiceCtrlHandler( TEXT(SZSERVICENAME), service_ctrl);
178 
179   }
180 
181   if (!sshStatusHandle)
182     goto cleanup;
183 
184    // SERVICE_STATUS members that don't change in example
185    //
186    ssStatus.dwServiceType = SERVICE_WIN32_OWN_PROCESS | SERVICE_INTERACTIVE_PROCESS;
187    ssStatus.dwServiceSpecificExitCode = 0;
188 
189 
190    // report the status to the service control manager.
191    //
192    if (!ReportStatusToSCMgr(
193                            SERVICE_START_PENDING, // service state
194                            NO_ERROR,              // exit code
195                            3000))                 // wait hint
196       goto cleanup;
197 
198 
199    ServiceStart( dwArgc, lpszArgv );
200 
201    cleanup:
202 
203    // try to report the stopped status to the service control manager.
204    //
205    if (sshStatusHandle)
206       (VOID)ReportStatusToSCMgr(
207                                SERVICE_STOPPED,
208                                dwErr,
209                                0);
210 
211    return;
212 }
\end{verbatim}\normalsize 
\hypertarget{Service_8cpp_a12}{
\index{Service.cpp@{Service.cpp}!wmain@{wmain}}
\index{wmain@{wmain}!Service.cpp@{Service.cpp}}
\subsubsection[wmain]{\setlength{\rightskip}{0pt plus 5cm}int \_\-\_\-cdecl wmain (int {\em argc}, WCHAR $\ast$ {\em argv}\mbox{[}$\,$\mbox{]}, WCHAR $\ast$ {\em envp}\mbox{[}$\,$\mbox{]})}}
\label{Service_8cpp_a12}


FUNCTION: main

PURPOSE: entrypoint for service

PARAMETERS: argc - number of command line arguments argv - array of command line arguments

RETURN VALUE: none

COMMENTS: main() either performs the command line task, or call Start\-Service\-Ctrl\-Dispatcher to register the main service thread. When the this call returns, the service has stopped, so exit. 

Definiert in Zeile 46 der Datei Service.cpp.

Benutzt Add\-To\-Message\-Log(), b\-Debug, Cmd\-Debug\-Service(), Cmd\-Install\-Service(), Cmd\-Remove\-Service(), L\_\-ILOGIN\_\-VERSION und service\_\-main().



\footnotesize\begin{verbatim}47 {
48   SERVICE_TABLE_ENTRY dispatchTable[] =
49   {
50     { TEXT(SZSERVICENAME), (LPSERVICE_MAIN_FUNCTION)service_main},
51     { NULL, NULL}
52   };
53 
54   wprintf(TEXT("Qbe Network Authentication v") L_ILOGIN_VERSION TEXT("\r\n"));
55   wprintf(TEXT("    (C) Copyright 2001-2004 Qbe Austria\r\n"));
56   wprintf(TEXT("    (C) Copyright 2001-2004 Christian Hofstaedtler\r\n"));
57   wprintf(TEXT("\r\n"));
58 
59   if ( (argc > 1) &&
60     ((*argv[1] == '-') || (*argv[1] == '/')) )
61   {
62     if ( wcsicmp( TEXT("install"), argv[1]+1 ) == 0 )
63     {
64       CmdInstallService();
65     }
66     else if ( wcsicmp( TEXT("remove"), argv[1]+1 ) == 0 )
67     {
68       CmdRemoveService();
69     }
70     else if ( wcsicmp( TEXT("debug"), argv[1]+1 ) == 0 )
71     {
72       bDebug = TRUE;
73       CmdDebugService(argc, argv);
74     }
75     else if ( wcsicmp( TEXT("start"), argv[1]+1 ) == 0 )
76     {
77       goto dispatch;
78     }
79     else
80     {
81       goto usage;
82     }
83 
84   } else {
85     goto usage;
86   }
87 
88 exit:
89   wprintf(TEXT("\r\nQbeSvc terminates.\r\n"));
90   return 0;
91 
92 usage:
93   wprintf(TEXT("This command is not supported.\r\n"));
94   wprintf(TEXT(" Supported parameters:\r\n"));
95   wprintf(TEXT("  -install\r\n")); 
96   wprintf(TEXT("  -remove\r\n")); 
97   wprintf(TEXT("  -start (only useful for the ServiceManager)\r\n")); 
98   goto exit;
99 
100 
101   // if it doesn't match any of the above parameters
102   // the service control manager may be starting the service
103   // so we must call StartServiceCtrlDispatcher
104   dispatch:
105 
106   if (!StartServiceCtrlDispatcher(dispatchTable))
107     AddToMessageLog(MSG_ERROR,TEXT("StartServiceCtrlDispatcher failed."));
108 
109   return 0;
110 }
\end{verbatim}\normalsize 


\subsection{Variablen-Dokumentation}
\hypertarget{Service_8cpp_a3}{
\index{Service.cpp@{Service.cpp}!bDebug@{bDebug}}
\index{bDebug@{bDebug}!Service.cpp@{Service.cpp}}
\subsubsection[bDebug]{\setlength{\rightskip}{0pt plus 5cm}BOOL \hyperlink{Service_8cpp_a3}{b\-Debug} = FALSE}}
\label{Service_8cpp_a3}




Definiert in Zeile 16 der Datei Service.cpp.

Wird benutzt von Add\-To\-Message\-Log(), Report\-Status\-To\-SCMgr() und wmain().\hypertarget{Service_8cpp_a2}{
\index{Service.cpp@{Service.cpp}!dwErr@{dwErr}}
\index{dwErr@{dwErr}!Service.cpp@{Service.cpp}}
\subsubsection[dwErr]{\setlength{\rightskip}{0pt plus 5cm}\hyperlink{QbeGina_8h_a2}{DWORD} \hyperlink{Service_8cpp_a2}{dw\-Err} = 0}}
\label{Service_8cpp_a2}




Definiert in Zeile 15 der Datei Service.cpp.

Wird benutzt von Add\-To\-Message\-Log() und service\_\-main().\hypertarget{Service_8cpp_a1}{
\index{Service.cpp@{Service.cpp}!sshStatusHandle@{sshStatusHandle}}
\index{sshStatusHandle@{sshStatusHandle}!Service.cpp@{Service.cpp}}
\subsubsection[sshStatusHandle]{\setlength{\rightskip}{0pt plus 5cm}SERVICE\_\-STATUS\_\-HANDLE \hyperlink{Service_8cpp_a1}{ssh\-Status\-Handle}}}
\label{Service_8cpp_a1}




Definiert in Zeile 14 der Datei Service.cpp.

Wird benutzt von Report\-Status\-To\-SCMgr() und service\_\-main().\hypertarget{Service_8cpp_a0}{
\index{Service.cpp@{Service.cpp}!ssStatus@{ssStatus}}
\index{ssStatus@{ssStatus}!Service.cpp@{Service.cpp}}
\subsubsection[ssStatus]{\setlength{\rightskip}{0pt plus 5cm}SERVICE\_\-STATUS \hyperlink{Service_8cpp_a0}{ss\-Status}}}
\label{Service_8cpp_a0}




Definiert in Zeile 13 der Datei Service.cpp.

Wird benutzt von Cmd\-Remove\-Service(), Win\-Service\-API::Remove\-Service(), Report\-Status\-To\-SCMgr(), service\_\-ctrl() und service\_\-main().\hypertarget{Service_8cpp_a4}{
\index{Service.cpp@{Service.cpp}!szErr@{szErr}}
\index{szErr@{szErr}!Service.cpp@{Service.cpp}}
\subsubsection[szErr]{\setlength{\rightskip}{0pt plus 5cm}TCHAR \hyperlink{Service_8cpp_a4}{sz\-Err}\mbox{[}256\mbox{]}}}
\label{Service_8cpp_a4}




Definiert in Zeile 17 der Datei Service.cpp.

Wird benutzt von Cmd\-Install\-Service() und Cmd\-Remove\-Service().